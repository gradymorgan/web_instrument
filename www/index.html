<!DOCTYPE html>
<html>
    <head>
        <title>Instrument Display</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=500px, user-scalable=no">
        <link rel="stylesheet" type="text/css" href="css/main.css">
        <style type="text/css">
        svg {
            background-color: white;
        }

        .axis text {
          font: 10px sans-serif;
        }

        .axis line {
            fill: none;
            stroke: #777;
            stroke-dasharray: 2,4;
        }

        .axis circle {
            fill: none;
            stroke: #999;
            stroke-dasharray: 4,2;
        }

        .axis :last-of-type circle {
            stroke: #333;
            stroke-dasharray: none;
        }

        circle.st {
            stroke: blue;
            stroke-width: 0;
            fill: blue;
        }

        </style>

    </head>
    <body>
        <div id="screen"></div>
        
        <script src="/lib/jquery.js"></script>
        <script src="/lib/underscore.js"></script>
        <script src="/lib/backbone.js"></script>
        <script src="/lib/d3.js"></script>
        <script src="/lib/sprintf.js"></script>

        <script src="js/displays/screen.js"></script>
        <script src="js/displays/speed.js"></script>
        <script src="js/displays/vmg.js"></script>

        <script>
            var metricConfigs = {
                'hdg': { 'label': 'hdg', 'unit': '°', 'format': '%.1f' },
                'heel': { 'label': 'hl', 'unit': '°', 'format': '%.1f' },
                'pitch': { 'label': 'pch', 'unit': '°', 'format': '%.1f' },
                'speed': { 'label': 'spd', 'unit': 'kts', 'format': '%.2f' }
            };

            function screenFactory(metric, model) {
                var options = _.extend({'model': model, 'metric': metric}, metricConfigs[metric]);

                var display = new genericScreen(options);
                $('#screen').append(display.el);
                display.render();

                return display;
            }

            var timer = null;
            function stop() {
                if (timer) {
                    clearInterval(timer);
                    timer = null;
                }
            }

            function startListening(model) {
                window.model = model;

                //TODO: backoff if results stop comming back
                timer = setInterval(function() {
                    $.ajax({
                        dataType: "json",
                        url: '/now',
                        cache: false,
                        success: function(d) { 
                            _.each(['hdg', 'heel', 'pitch'], function(metric) {
                                if (metric in d) {
                                    model.set(metric, d[metric]);
                                }
                            });
                        }
                    });
                }, 1000);


                // var source = new EventSource('/stream');
                // source.addEventListener('message', function(e) {
                //     var data = JSON.parse(e.data);
                    
                //     console.info(data);
                //     window.hdgDisplay.render(data);
                //     // window.vmgDisplay.update(data)

                // }, false);
            }

            $(function() {
                var state = Backbone.Model.extend({});
                var data = new state({'hdg': 123.0, 'heel': 1.3, 'speed':5.6});

                _.each(['hdg', 'heel', 'pitch'], function(metric) {
                    screenFactory(metric, data);
                });
                

                startListening(data);
            });
        </script>
    </body>
</html>
